---
title: "Predict Disease Outcome by Community Structures"
author: "Nicholas Lesniak"
date: "July 13, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
```

```{r, message=FALSE}
pack_used <- c('randomForest','miscTools','ggplot2','reshape2', 'pROC', 'knitr', 'cowplot','dplyr','AUCRF')
for (dep in pack_used){
  if (dep %in% installed.packages()[,"Package"] == FALSE){
    install.packages(as.character(dep), repos = 'http://cran.us.r-project.org', 
                     quiet=TRUE);
  }
  library(dep, verbose=FALSE, character.only=TRUE)
}
```

## Can Day 0 Community members predict C. difficile CFU?
```{r fig.height= 10, fig.width=10}

meta_file   <- '~/Documents/Github/Schubert_humanCdGF_XXXX_2016/data/process/human_CdGF_metadata.txt'
shared_file <- '~/Documents/Github/Schubert_humanCdGF_XXXX_2016/data/process/human_CdGF.an.unique_list.0.03.subsample.shared'
tax_file <- '~/Documents/Github/Schubert_humanCdGF_XXXX_2016/data/mothur/gf_all.an.cons.taxonomy'
tax_function <- '~/Documents/Github/Schubert_humanCdGF_XXXX_2016/code/tax_level.R'

# read in files
meta_file   <- read.table(meta_file, sep = '\t', header = T, row.names = 'sample_id')
shared_file <- read.table(shared_file, sep = '\t', header = T, row.names = 'sample_id')
tax_file <- read.table(tax_file, sep = '\t', header = T, row.names = 'OTU')
source(tax_function)

# select only mice with 431 cdiff
meta_file <- meta_file[meta_file$cdiff_strain == '431', ]

# subset shared
#Create df with relative abundances
stool_shared <- shared_file[rownames(meta_file[meta_file$day %in% 0, ]) ,]
# use %in% instead of == because to ignore NA
# rename day 0 community rows by mouse id - since meta rows have day in row names, use mouse id for both
rownames(stool_shared) <- meta_file$mouse_id[rownames(meta_file) %in% 
                                               rownames(stool_shared) ]
rel_abund_stool <- 100 * stool_shared / unique(apply(stool_shared, 1, sum))
#Create vector of OTUs with median abundances >1%
OTUs_stool_0_01 <- apply(rel_abund_stool, 2, max) > 1
#df of OTUs with abundances >1% - by cage and inoculum
rel_abund_stool <- rel_abund_stool[ ,OTUs_stool_0_01]
OTU_list <- colnames(rel_abund_stool)

#random forest regression model to determine Day 0 OTU correlated with increased CFU
seed <- 18
n_trees <- 2001
set.seed(seed)

#log_cfu_obs <- meta_file[meta_file$day %in% c(0:10), c('mouse_id', 'day', 'log_cfu') ]
#log_cfu_obs$predict <- NA
#log_cfu_obs[log_cfu_obs$day==2, ] <- predict(RF, rel_abund_stool)

importance_df <- data.frame(matrix(nrow = length(OTU_list), 
                                   ncol = max(meta_file$day, na.rm = T)),
                            row.names = OTU_list)
rsq_df <- data.frame(matrix(nrow = 1, ncol = max(meta_file$day, na.rm = T)),
                         row.names = 'RSQ')
mse_df <- data.frame(matrix(nrow = 1, ncol = max(meta_file$day, na.rm = T)),
                         row.names = 'MSE')
prediction_df <- data.frame(matrix(nrow = 0, ncol = 4))
rsq_features <- data.frame('Day'=NA, 'Features (n)'= NA, 'RSQ'=NA, 'MSE'=NA)

for (i in 1:10){
  predict_all_df <- merge(meta_file[meta_file$day==i, c('mouse_id', 'day' , 'log_cfu') ],
                    rel_abund_stool, by='mouse_id', by.y='row.names', all.y = T)
  predict_df <- predict_all_df[,! colnames(predict_all_df) %in% 'day']
  predict_df <- predict_df[ ,!(colnames(predict_df) %in% "mouse_id")]
  RF <- randomForest(log_cfu ~ ., data = predict_df[!is.na(predict_df$log_cfu), ],
                   importance = TRUE, ntree = n_trees)
  rsq_df[i] <- RF$rsq[length(RF$rsq)]
  mse_df[i] <- RF$mse[length(RF$mse)]

  # sort the features by their effect on % increase in the standard error
  importance_df[ , i] <- importance(RF)[,1]
  importance_sorted <- sort(importance(RF)[,1], decreasing = T)
  colnames(importance_df)[i] <- paste('day', i, 'importance', sep = '_')
# fit the model back on the datar and tack it to the end of the counts file
  random_forest_output <- cbind(predict_all_df[!is.na(predict_all_df$log_cfu), c('day','log_cfu')],
                              RF$predicted)
  colnames(random_forest_output) <- c('day', 'observed', 'predicted')
  prediction_df <- rbind(prediction_df, random_forest_output) 
  for (k in 1:25){
    n_features <- k
    rf_partial <- randomForest(log_cfu ~ ., data=predict_df[!is.na(predict_df$log_cfu),
                            c( 'log_cfu', names(importance_sorted)[1:n_features])], 
                           importance=TRUE, ntree=n_trees)
    rsq_features <- rbind(rsq_features, c(i, k, tail(rf_partial$rsq, 1), tail(rf_partial$mse, 1)))
  }
}
rsq_features <- rsq_features[-1,]


day_0_rf_plot <- ggplot(data = prediction_df, aes(x=observed, y=predicted)) + geom_point() + 
        facet_wrap( ~ day, nrow = 2) + 
        labs(title = 'Random Forest Prediction of C Diff CFU dpi from Day 0 Community',
        x= 'Observed CFU (log10)', y = 'Predicted CFU (log10)')

rsq_df <- t(rsq_df)
rsq_df <- as.data.frame(cbind(rsq_df, day = c(1:10)))
day_0_rsq_plot <- ggplot(data = rsq_df, aes(x = factor(day), y = RSQ)) + geom_point() + theme_bw() +
        labs(x= 'Day', y = 'R^2') #title = 'Variation Explained by Day of C Diff CFU dpi from Day 0 Community',

mse_df <- t(mse_df)
mse_df <- as.data.frame(cbind(mse_df, day = c(1:10)))
day_0_mse_plot <- ggplot(data = mse_df, aes(x = factor(day), y = MSE)) + geom_point() + theme_bw() +
        labs(x= 'Day', y = 'MSE') # title = 'MSE by Day of C Diff CFU dpi from Day 0 Community',
day_0_r2feat_plot <- ggplot(rsq_features, aes(x=Features..n., y=RSQ, group=(Day), color=factor(Day))) + geom_line() +
  labs(x = 'Features (n)', y = 'R^2') + scale_color_discrete(guide=FALSE) + theme_bw()
#  title= 'R^2 from RF with top n features\n
#                    Day of C Diff CFU dpi from Day 0 Community', scale_color_discrete(name = 'Day')

n_important <- 20
median_importance <- names(head(sort((apply(importance_df,1, median)), decreasing = T), n_important))
med_import_df <- melt(cbind(rownames(importance_df), importance_df)[median_importance, ])
colnames(med_import_df) <- c('OTU', 'Day', 'Importance')
day_0_feat_plot <- ggplot(data = med_import_df, aes(x = factor(Day), y = Importance)) + facet_wrap( ~ OTU, nrow = 2) +
        geom_point() + scale_x_discrete(labels = c(1:10)) +
        labs(title = 'OTU Importance in Prediction of C Diff CFU dpi from Day 0 Community\n (Top 20 Median OTUs)',
        x= 'Day', y = '% Increase in MSE') + theme_bw()

ggdraw()+
  draw_plot(day_0_rf_plot, 0, 0.5, 0.75, 0.5) + 
  draw_plot(day_0_rsq_plot, 0.875, 0.75, 0.125, 0.25) +
  draw_plot(day_0_mse_plot, 0.75, 0.75, 0.125, 0.25) + 
  draw_plot(day_0_r2feat_plot, 0.75, 0.5, 0.25, 0.25) + 
  draw_plot(day_0_feat_plot, 0, 0, 1, 0.5)
```

##Can we predict the endpoint C. difficile CFU with the community structure at Day 0?
Endpoint has data from Day 2,3,10 - might be misleading since contains CFU from different data points
     
```{r fig.height= 5, fig.width=10}

CFU_euth <- merge(meta_file[meta_file$day==meta_file$last_day_by_mouse, c('mouse_id', 'log_cfu') ],
                    rel_abund_stool, by='mouse_id', by.y='row.names', all.y = T)
CFU_euth <- CFU_euth[ ,!(colnames(CFU_euth) %in% "mouse_id")]

RF_CFU_day_euth <- randomForest(log_cfu ~ ., data = CFU_euth[!is.na(CFU_euth$log_cfu), ],
                   importance = TRUE, ntree = n_trees)
rsq_day_euth <- round(RF_CFU_day_euth$rsq[length(RF_CFU_day_euth$rsq)], 2)
mse_day_euth <- round(RF_CFU_day_euth$mse[length(RF_CFU_day_euth$mse)], 2)
# sort the features by their effect on % increase in the standard error
importance_day_euth <- importance(RF_CFU_day_euth)[,1]
# fit the model back on the datar and tack it to the end of the counts file
rf_predict_cfu_output <- cbind(CFU_euth[!is.na(CFU_euth$log_cfu), 'log_cfu'], data.frame(RF_CFU_day_euth$predicted))
colnames(rf_predict_cfu_output) <- c('observed', 'predicted')

day_euth_rf_plot <- ggplot(data = rf_predict_cfu_output, aes(x=observed, y=predicted)) + geom_point() + 
        labs(x= 'Observed CFU (log10)', y = 'Predicted CFU (log10)') + theme_bw() + 
        ggtitle("Random Forest Prediction of C Diff CFU \n on Day Euthanized from Day 0 Community") +
        annotate('text', x=0.15*(max(rf_predict_cfu_output$observed)), y=0.95*(max(rf_predict_cfu_output$predicted)), 
                 label=paste('R^2 = ', rsq_day_euth,'\nMSE = ', mse_day_euth, sep = ''))

top_important_OTU <- data.frame(head(sort(importance_day_euth, decreasing = T), n_important))
colnames(top_important_OTU) <- 'Importance'
top_important_OTU$OTU <- rownames(top_important_OTU)

n_feat_day_euth <- data.frame('Features (n)'= NA, 'RSQ'=NA, 'MSE'=NA)
importance_sorted_euth <- sort(importance(RF)[,1], decreasing = T)

for (k in 1:25){
    n_features <- k
    rf_partial <- randomForest(log_cfu ~ ., data=CFU_euth[!is.na(CFU_euth$log_cfu),
                            c( 'log_cfu', names(importance_sorted_euth)[1:n_features])], 
                           importance=TRUE, ntree=n_trees)
    n_feat_day_euth <- rbind(n_feat_day_euth, c(k, tail(rf_partial$rsq, 1), tail(rf_partial$mse, 1)))
}
n_feat_day_euth <- n_feat_day_euth[-1,]

day_euth_r2feat_plot <- ggplot(n_feat_day_euth, aes(x=Features..n., y=RSQ)) + geom_line() +
  labs(x = 'Features (n)', y = 'R^2') + theme_bw()
#     title= 'R^2 from RF with top n features\n Day euthanized C Diff CFU from Day 0 Community',

day_euth_feat_plot <- ggplot(data = top_important_OTU, aes(x = factor(OTU), y = Importance)) + 
        geom_point() + scale_x_discrete(limits = rev(top_important_OTU$OTU)) +
        labs(x= '', y = '% Increase in MSE') + theme_bw() + coord_flip()
#        title = 'OTU Importance in Prediction of euthanized C Diff CFU from Day 0 Community',

ggdraw()+
  draw_plot(day_euth_rf_plot, 0, 0.5, 0.5, 0.5) + 
  draw_plot(day_euth_r2feat_plot, 0, 0, 0.5, 0.5) +
  draw_plot(day_euth_feat_plot, 0.5, 0, 0.5, 1)

```


## Does Community structure predict C. difficile CFU of same day?

### RF cfu vs community by day

```{r fig.height= 10, fig.width=10}

#remove c diff from shared
cdiff_otu <- rownames(tax_file[grep('Clostridium_XI', tax_file$Taxonomy),])
shared_X_cdiff <- shared_file[, ! colnames(shared_file) %in% cdiff_otu]
shared_X_cdiff_ra <-  100 * shared_X_cdiff / unique(apply(shared_X_cdiff, 1, sum))
OTUs_01 <- apply(shared_X_cdiff_ra, 2, max) > 1
shared_X_cdiff_ra <- shared_X_cdiff_ra[, OTUs_01]
# create data frame with shared and cfu and day
CFU_community_by_day <- merge(meta_file[meta_file$day %in% c(1:10), c('day','log_cfu')], shared_X_cdiff_ra,
                              by = 'row.names')

###################################

importance_df_day <- data.frame(matrix(nrow = sum(OTUs_01*1), 
                                   ncol = max(meta_file$day, na.rm = T)),
                            row.names = colnames(shared_X_cdiff_ra))
rsq_df_day <- data.frame(matrix(nrow = 1, ncol = max(meta_file$day, na.rm = T)),
                         row.names = 'RSQ')
mse_df_day <- data.frame(matrix(nrow = 1, ncol = max(meta_file$day, na.rm = T)),
                         row.names = 'MSE')
prediction_df_day <- data.frame(matrix(nrow = 0, ncol = 4))
rsq_features_day <- data.frame('Day'=NA, 'Features (n)'= NA, 'RSQ'=NA, 'MSE'=NA)

for (i in 1:10){
  predict_all_df <- CFU_community_by_day[CFU_community_by_day$day == i ,]
  predict_df <- predict_all_df[!is.na(predict_all_df$log_cfu), 
                           !colnames(predict_all_df) %in% c('Row.names', 'day')]
  RF <- randomForest(log_cfu ~ ., data = predict_df,
                   importance = TRUE, ntree = n_trees)
  rsq_df_day[i] <- RF$rsq[length(RF$rsq)]
  mse_df_day[i] <- RF$mse[length(RF$mse)]

  # sort the features by their effect on % increase in the standard error
  importance_df_day[ , i] <- importance(RF)[,1]
  importance_sorted <- sort(importance(RF)[,1], decreasing = T)
  colnames(importance_df_day)[i] <- paste('day', i, 'importance', sep = '_')
# fit the model back on the datar and tack it to the end of the counts file
  random_forest_output <- cbind(predict_all_df[!is.na(predict_all_df$log_cfu), c('day','log_cfu')],
                              RF$predicted)
  colnames(random_forest_output) <- c('day', 'observed', 'predicted')
  prediction_df_day <- rbind(prediction_df_day, random_forest_output) 
  for (k in 1:25){
    n_features <- k
    rf_partial <- randomForest(log_cfu ~ ., 
                               data=predict_df[ , c( 'log_cfu', names(importance_sorted)[1:n_features])], 
                               importance=TRUE, ntree=n_trees)
    rsq_features_day <- rbind(rsq_features_day, c(i, k, tail(rf_partial$rsq, 1), tail(rf_partial$mse, 1)))
  }
}
rsq_features_day <- rsq_features_day[-1,]


day_rf_plot <- ggplot(data = prediction_df_day, aes(x=observed, y=predicted)) + geom_point() + 
        facet_wrap( ~ day, nrow = 2) + 
        labs(title = 'Random Forest Prediction of C Diff CFU dpi from Community on same day',
        x= 'Observed CFU (log10)', y = 'Predicted CFU (log10)')

rsq_df_day <- t(rsq_df_day)
rsq_df_day <- as.data.frame(cbind(rsq_df_day, day = c(1:10)))
day_rsq_plot <- ggplot(data = rsq_df_day, aes(x = factor(day), y = RSQ)) + geom_point() + theme_bw() +
        labs(x= 'Day', y = 'R^2') # title = 'Variation Explained by Day of C Diff CFU dpi from Community on same day',

mse_df_day <- t(mse_df_day)
mse_df_day <- as.data.frame(cbind(mse_df_day, day = c(1:10)))
day_mse_plot <- ggplot(data = mse_df_day, aes(x = factor(day), y = MSE)) + geom_point() + theme_bw() +
        labs(x= 'Day', y = 'MSE') # title = 'MSE by Day of C Diff CFU dpi from Community on same day',

day_r2feat_plot <- ggplot(rsq_features_day, aes(x=Features..n., y=RSQ, group=(Day), color=factor(Day))) + geom_line() +
  labs(x = 'Features (n)', y = 'R^2') + scale_color_discrete(guide = FALSE) + theme_bw()
# title= 'R^2 from RF with top n features\n Day of C Diff CFU dpi from Community on same day', 

n_important <- 20
median_importance <- names(head(sort((apply(importance_df_day,1, median)), decreasing = T), n_important))
med_import_df <- melt(cbind(rownames(importance_df_day), importance_df_day)[median_importance, ])
colnames(med_import_df) <- c('OTU', 'Day', 'Importance')

day_feat_plot <- ggplot(data = med_import_df, aes(x = factor(Day), y = Importance)) + facet_wrap( ~ OTU, nrow = 2) +
        geom_point() + scale_x_discrete(labels = c(1:10)) +
        labs(title = 'OTU Importance in Prediction of C Diff CFU dpi from Community on same day\n (Top 20 Median OTUs)',
        x= 'Day', y = '% Increase in MSE') + theme_bw()

ggdraw()+
  draw_plot(day_rf_plot, 0, 0.5, 0.75, 0.5) + 
  draw_plot(day_rsq_plot, 0.875, 0.75, 0.125, 0.25) +
  draw_plot(day_mse_plot, 0.75, 0.75, 0.125, 0.25) + 
  draw_plot(day_r2feat_plot, 0.75, 0.5, 0.25, 0.25) + 
  draw_plot(day_feat_plot, 0, 0, 1, 0.5)
```


####
RF all mice/days together

```{r fig.height= 7, fig.width=10}
predict_cfu_all_df <- CFU_community_by_day[!is.na(CFU_community_by_day$log_cfu),
                                           ! colnames(CFU_community_by_day) %in% c('Row.names','day')]
RF_cfu_all_rf <- randomForest(log_cfu ~ ., data = predict_cfu_all_df,
                   importance = TRUE, ntree = n_trees)
RF_cfu_all_df <- data.frame(cbind(CFU_community_by_day[!is.na(CFU_community_by_day$log_cfu), 
                                                       c('day','log_cfu')], 
                                  predicted = RF_cfu_all_rf$predicted))

mse_all <- tail(RF_cfu_all_rf$mse, 1)
rsq_all <- tail(RF_cfu_all_rf$rsq, 1)

all_rf_plot <- ggplot(data = RF_cfu_all_df, aes(x = log_cfu, y = predicted)) + geom_point() +
        labs(x= 'Observed CFU (log10)', y = 'Predicted CFU (log10)') + theme_bw() + 
        ggtitle("Random Forest Prediction of C Diff CFU") +
        annotate('text', x=0.15*(max(RF_cfu_all_df$log_cfu)), y=0.95*(max(RF_cfu_all_df$predicted)), 
                 label=paste('R^2 = ', round(tail(RF_cfu_all_rf$rsq, 1), 2),
                             '\nMSE = ', round(tail(RF_cfu_all_rf$mse, 1), 2), sep = ''))

importance_all <- sort(importance(RF_cfu_all_rf)[,1], decreasing = T)

rsq_features_all <- data.frame('Features'= NA, 'RSQ'=NA, 'MSE'=NA)
for (k in 1:25){
    rf_partial <- randomForest(log_cfu ~ ., 
                               data=predict_cfu_all_df[ , c( 'log_cfu', names(importance_all)[1:k])], 
                               importance=TRUE, ntree=n_trees)
    rsq_features_all <- rbind(rsq_features_all, c(k, tail(rf_partial$rsq, 1), tail(rf_partial$mse, 1)))
}
rsq_features_all <- rsq_features_all[-1,]
all_r2feat_plot <- ggplot(rsq_features_all, aes(x=Features, y=RSQ)) + geom_line() +
  labs(x = 'Features (n)', y = 'R^2') + scale_color_discrete(guide = FALSE) + theme_bw()

important_OTU_all <- data.frame(head(importance_all, n_important))
colnames(important_OTU_all) <- 'Importance'
important_OTU_all$OTU <- rownames(important_OTU_all)

all_feat_plot <- ggplot(data = important_OTU_all, aes(x = factor(OTU), y = Importance)) + 
        geom_point() + scale_x_discrete(limits = rev(important_OTU_all$OTU)) +
        labs(x= '', y = '% Increase in MSE') + theme_bw() + coord_flip()

ggdraw()+
  draw_plot(all_rf_plot, 0, 0.5, 0.5, 0.5) + 
  draw_plot(all_r2feat_plot, 0, 0, 0.5, 0.5) +
  draw_plot(all_feat_plot, 0.5, 0, 0.5, 1)

```


## Does removing the early euthanized samples improve prediction in days 1 to 3?

```{r fig.height= 10, fig.width=10}

without_early_euth <- meta_file[meta_file$Early_Euth == FALSE ,c('day', 'mouse_id', 'log_cfu')]
without_early_euth <- without_early_euth[without_early_euth$day %in% c(1:4), ]

without_by_day <- merge(without_early_euth, shared_X_cdiff_ra, by  = 'row.names')
without_day_0 <- merge(without_early_euth, rel_abund_stool, by='mouse_id', by.y='row.names' )

###################################

importance_persist <- data.frame(matrix(nrow = length(OTU_list), 
                                   ncol = max(without_early_euth$day, na.rm = T)),
                            row.names = OTU_list)
rsq_persist <- data.frame(matrix(nrow = 1, ncol = max(without_early_euth$day, na.rm = T)),
                         row.names = 'RSQ')
mse_persist <- data.frame(matrix(nrow = 1, ncol = max(without_early_euth$day, na.rm = T)),
                         row.names = 'MSE')
prediction_persist <- data.frame(matrix(nrow = 0, ncol = 4))
features_persist <- data.frame('Day'=NA, 'Features (n)'= NA, 'RSQ'=NA, 'MSE'=NA)

for (i in 1:4){
  predict_all_df <- without_day_0[without_day_0$day == i ,]
  predict_df <- predict_all_df[!is.na(predict_all_df$log_cfu), 
                           !colnames(predict_all_df) %in% c('mouse_id', 'day')]
  RF <- randomForest(log_cfu ~ ., data = predict_df,
                   importance = TRUE, ntree = n_trees)
  rsq_persist[i] <- RF$rsq[length(RF$rsq)]
  mse_persist[i] <- RF$mse[length(RF$mse)]

  # sort the features by their effect on % increase in the standard error
  importance_persist[ , i] <- importance(RF)[,1]
  importance_sorted <- sort(importance(RF)[,1], decreasing = T)
  colnames(importance_persist)[i] <- paste('day', i, 'importance', sep = '_')
# fit the model back on the datar and tack it to the end of the counts file
  random_forest_output <- cbind(predict_all_df[!is.na(predict_all_df$log_cfu), c('day','log_cfu')],
                              RF$predicted)
  colnames(random_forest_output) <- c('day', 'observed', 'predicted')
  prediction_persist <- rbind(prediction_persist, random_forest_output) 
  for (k in 1:25){
    n_features <- k
    rf_partial <- randomForest(log_cfu ~ ., 
                               data=predict_df[ , c( 'log_cfu', names(importance_sorted)[1:n_features])], 
                               importance=TRUE, ntree=n_trees)
    features_persist <- rbind(features_persist, c(i, k, tail(rf_partial$rsq, 1), tail(rf_partial$mse, 1)))
  }
}
features_persist <- features_persist[-1,]


day_0_persist_rf_plot <- ggplot(data = prediction_persist, aes(x=observed, y=predicted)) + geom_point() + 
        facet_grid( ~ day) + 
        labs(title = 'Random Forest Prediction of C Diff CFU dpi from Community on Day 0
                      \nwithout mice euthanized early', x= 'Observed CFU (log10)', 
             y = 'Predicted CFU (log10)')

rsq_persist <- t(rsq_persist)
rsq_persist <- as.data.frame(cbind(rsq_persist, day = c(1:4)))
day_0_persist_rsq_plot <- ggplot(data = rsq_persist, aes(x = factor(day), y = RSQ)) + geom_point() + theme_bw() +
        labs(x= 'Day', y = 'R^2') 
#title = 'Variation Explained by Day of C Diff CFU dpi from Community on Day 0\nwithout mice euthanized early', 

mse_persist <- t(mse_persist)
mse_persist <- as.data.frame(cbind(mse_persist, day = c(1:4)))
day_0_persist_mse_plot <- ggplot(data = mse_persist, aes(x = factor(day), y = MSE)) + geom_point() + theme_bw() +
        labs(x = 'Day', y = 'MSE')
#title = 'MSE by Day of C Diff CFU dpi from Community on Day 0\nwithout mice euthanized early', 

day_0_persist_r2feat_plot <- ggplot(features_persist, aes(x=Features..n., y=RSQ, group=(Day), color=factor(Day))) + 
  geom_line() + labs(x = 'Features (n)', y = 'R^2') + scale_color_discrete(guide = FALSE) + theme_bw()
#title= 'R^2 from RF with top n features\nDay of C Diff CFU dpi from Community on Day 0\nwithout mice euthanized early', 

n_important <- 20
median_importance <- names(head(sort((apply(importance_persist,1, median)), decreasing = T), n_important))
med_import_df <- melt(cbind(rownames(importance_persist), importance_persist)[median_importance, ])
colnames(med_import_df) <- c('OTU', 'Day', 'Importance')

day_0_persist_feat_plot <- ggplot(data = med_import_df, aes(x = factor(Day), y = Importance)) + 
  facet_wrap( ~ OTU, nrow = 2) + geom_point() + scale_x_discrete(labels = c(1:10)) +
        labs(title = 'OTU Importance in Prediction of C Diff CFU dpi from Community
             on Day 0\nwithout mice euthanized early - (Top 20 Median OTUs)',
        x= 'Day', y = '% Increase in MSE') + theme_bw()

ggdraw()+
  draw_plot(day_0_persist_rf_plot, 0, 0.5, 0.75, 0.5) + 
  draw_plot(day_0_persist_rsq_plot, 0.875, 0.75, 0.125, 0.25) +
  draw_plot(day_0_persist_mse_plot, 0.75, 0.75, 0.125, 0.25) + 
  draw_plot(day_0_persist_r2feat_plot, 0.75, 0.5, 0.25, 0.25) + 
  draw_plot(day_0_persist_feat_plot, 0, 0, 1, 0.5)



importance_persist_day <- data.frame(matrix(nrow = sum(OTUs_01*1), 
                                   ncol = max(without_early_euth$day, na.rm = T)),
                            row.names = colnames(shared_X_cdiff_ra))
rsq_persist_day <- data.frame(matrix(nrow = 1, ncol = max(without_early_euth$day, na.rm = T)),
                         row.names = 'RSQ')
mse_persist_day <- data.frame(matrix(nrow = 1, ncol = max(without_early_euth$day, na.rm = T)),
                         row.names = 'MSE')
prediction_persist_day <- data.frame(matrix(nrow = 0, ncol = 4))
features_persist_day <- data.frame('Day'=NA, 'Features (n)'= NA, 'RSQ'=NA, 'MSE'=NA)

for (i in 1:4){
  predict_all_df <- without_by_day[without_by_day$day == i ,]
  predict_df <- predict_all_df[!is.na(predict_all_df$log_cfu), 
                           !colnames(predict_all_df) %in% c('mouse_id', 'Row.names', 'day')]
  RF <- randomForest(log_cfu ~ ., data = predict_df,
                   importance = TRUE, ntree = n_trees)
  rsq_persist_day[i] <- RF$rsq[length(RF$rsq)]
  mse_persist_day[i] <- RF$mse[length(RF$mse)]

  # sort the features by their effect on % increase in the standard error
  importance_persist_day[ , i] <- importance(RF)[,1]
  importance_sorted <- sort(importance(RF)[,1], decreasing = T)
  colnames(importance_persist_day)[i] <- paste('day', i, 'importance', sep = '_')
# fit the model back on the datar and tack it to the end of the counts file
  random_forest_output <- cbind(predict_all_df[!is.na(predict_all_df$log_cfu), c('day','log_cfu')],
                              RF$predicted)
  colnames(random_forest_output) <- c('day', 'observed', 'predicted')
  prediction_persist_day <- rbind(prediction_persist_day, random_forest_output) 
  for (k in 1:25){
    n_features <- k
    rf_partial <- randomForest(log_cfu ~ ., 
                               data=predict_df[ , c( 'log_cfu', names(importance_sorted)[1:n_features])], 
                               importance=TRUE, ntree=n_trees)
    features_persist_day <- rbind(features_persist_day, c(i, k, tail(rf_partial$rsq, 1), tail(rf_partial$mse, 1)))
  }
}
features_persist_day <- features_persist_day[-1,]


day_persist_rf_plot <- ggplot(data = prediction_persist_day, aes(x=observed, y=predicted)) + geom_point() + 
        facet_grid( ~ day) + 
        labs(title = 'Random Forest Prediction of C Diff CFU dpi from Community on same day\nwithout mice euthanized early',
        x= 'Observed CFU (log10)', y = 'Predicted CFU (log10)')

rsq_persist_day <- t(rsq_persist_day)
rsq_persist_day <- as.data.frame(cbind(rsq_persist_day, day = c(1:4)))
day_persist_rsq_plot <- ggplot(data = rsq_persist_day, aes(x = factor(day), y = RSQ)) + geom_point() + theme_bw() +
        labs(x= 'Day', y = 'R^2')
#title = 'Variation Explained by Day of C Diff CFU dpi from Community on same day\nwithout mice euthanized early',

mse_persist_day <- t(mse_persist_day)
mse_persist_day <- as.data.frame(cbind(mse_persist_day, day = c(1:4)))
day_persist_mse_plot <- ggplot(data = mse_persist_day, aes(x = factor(day), y = MSE)) + geom_point() + theme_bw() +
        labs(x= 'Day', y = 'MSE')
#title = 'MSE by Day of C Diff CFU dpi from Community on same day\nwithout mice euthanized early',

day_persist_r2feat_plot <- ggplot(features_persist_day, aes(x=Features..n., y=RSQ, group=(Day), color=factor(Day))) + geom_line() +
  labs(x = 'Features (n)', y = 'R^2') + scale_color_discrete(guide  = FALSE) + theme_bw()
# title= 'R^2 from RF with top n features\n Day of C Diff CFU dpi from Community on same day\nwithout mice euthanized early', 

n_important <- 20
median_importance <- names(head(sort((apply(importance_persist_day,1, median)), decreasing = T), n_important))
med_import_df <- melt(cbind(rownames(importance_persist_day), importance_persist_day)[median_importance, ])
colnames(med_import_df) <- c('OTU', 'Day', 'Importance')

day_persist_feat_plot <- ggplot(data = med_import_df, aes(x = factor(Day), y = Importance)) + facet_wrap( ~ OTU, nrow = 2) +
        geom_point() + scale_x_discrete(labels = c(1:10)) +
        labs(title = 'OTU Importance in Prediction of C Diff CFU dpi from Community on same day\nwithout mice euthanized early - (Top 20 Median OTUs)',
        x= 'Day', y = '% Increase in MSE') + theme_bw()

ggdraw()+
  draw_plot(day_persist_rf_plot, 0, 0.5, 0.75, 0.5) + 
  draw_plot(day_persist_rsq_plot, 0.875, 0.75, 0.125, 0.25) +
  draw_plot(day_persist_mse_plot, 0.75, 0.75, 0.125, 0.25) + 
  draw_plot(day_persist_r2feat_plot, 0.75, 0.5, 0.25, 0.25) + 
  draw_plot(day_persist_feat_plot, 0, 0, 1, 0.5)
```

#### All CFU compared to same day community without mice euthanized early 
```{r fig.width=10, fig.height=5}

predict_cfu_persist_df <- without_by_day[!is.na(without_by_day$log_cfu),
                                           ! colnames(without_by_day) %in% c('Row.names','day','mouse_id')]
RF_cfu_persist_rf <- randomForest(log_cfu ~ ., data = predict_cfu_persist_df,
                   importance = TRUE, ntree = n_trees)
RF_cfu_persist_df <- data.frame(cbind(without_by_day[!is.na(without_by_day$log_cfu), 
                                                       c('day','log_cfu')], 
                                  predicted = RF_cfu_persist_rf$predicted))

mse_all <- tail(RF_cfu_persist_rf$mse, 1)
rsq_all <- tail(RF_cfu_persist_rf$rsq, 1)

all_persist_rf_plot <- ggplot(data = RF_cfu_persist_df, aes(x = log_cfu, y = predicted)) + geom_point() +
        labs(x= 'Observed CFU (log10)', y = 'Predicted CFU (log10)') + theme_bw() + 
        ggtitle("Random Forest Prediction of C Diff CFU") +
        annotate('text', x=0.15*(max(RF_cfu_persist_df$log_cfu)), y=0.95*(max(RF_cfu_persist_df$predicted)), 
                 label=paste('R^2 = ', round(tail(RF_cfu_persist_rf$rsq, 1), 2),
                             '\nMSE = ', round(tail(RF_cfu_persist_rf$mse, 1), 2), sep = ''))

importance_all_persist <- sort(importance(RF_cfu_persist_rf)[,1], decreasing = T)

rsq_features_all_persist <- data.frame('Features'= NA, 'RSQ'=NA, 'MSE'=NA)
for (k in 1:25){
    rf_partial <- randomForest(log_cfu ~ ., 
                               data=predict_cfu_persist_df[ , c( 'log_cfu', names(importance_all_persist)[1:k])], 
                               importance=TRUE, ntree=n_trees)
    rsq_features_all_persist <- rbind(rsq_features_all_persist, c(k, tail(rf_partial$rsq, 1), tail(rf_partial$mse, 1)))
}
rsq_features_all_persist <- rsq_features_all_persist[-1,]
all_persist_r2feat_plot <- ggplot(rsq_features_all_persist, aes(x=Features, y=RSQ)) + geom_line() +
  labs(x = 'Features (n)', y = 'R^2') + scale_color_discrete(guide = FALSE) + theme_bw()

important_OTU_all_persist <- data.frame(head(importance_all_persist, n_important))
colnames(important_OTU_all_persist) <- 'Importance'
important_OTU_all_persist$OTU <- rownames(important_OTU_all_persist)

all_persist_feat_plot <- ggplot(data = important_OTU_all_persist, aes(x = factor(OTU), y = Importance)) + 
        geom_point() + scale_x_discrete(limits = rev(important_OTU_all_persist$OTU)) +
        labs(x= '', y = '% Increase in MSE') + theme_bw() + coord_flip()

ggdraw()+
  draw_plot(all_persist_rf_plot, 0, 0.5, 0.5, 0.5) + 
  draw_plot(all_persist_r2feat_plot, 0, 0, 0.5, 0.5) +
  draw_plot(all_persist_feat_plot, 0.5, 0, 0.5, 1)

```



Eliminating mice euthanized early from the RF model gives similar R^2 and MSE, bu there is a slight advantage to community OTU features of Day 0 to predict Day1 CFU. As well as the R^2 value increases with increasing features, whereas when all mice are used the day 1 R^2 only decreases with increasing features. Of note, accompaied by this is an increase in the % MSE attributed to OTU15 (Akkermansia), which has seemed to stand out in all other days/analysis.Interestingly, akkermansia does not appear to have the same relationship when compared to the same day cfu and community. This could suggest akkermansia is promoting the intial colonization of c difficile.
At first glance, OTU135 (Coriobacteriaceae) seems to stand out for predicting cfu of the same day as well as from day 0.


***

##Can we predict moribundity with the community structure at Day 0?

```{r fig.width=6, fig.height=5}
meta_file$Euth_Early <- factor(ifelse(meta_file[ , 'Early_Euth'] == FALSE, 1, 0)) 

Predict_early_euth_df <- merge(meta_file[meta_file$day == 0, c('mouse_id', 'Euth_Early')], 
                               rel_abund_stool, by.x = 'mouse_id', by.y='row.names')
Predict_early_euth_df_names <- Predict_early_euth_df$mouse_id
Predict_early_euth_df <- select(Predict_early_euth_df, -mouse_id)

rf_early_aucrf <- AUCRF(Euth_Early ~ ., data = Predict_early_euth_df,
                              ntree = n_trees, pdel = 0.05, ranking = 'MDA')

otu_euth_probs <- predict(rf_early_aucrf$RFopt, type = 'prob')
otu_euth_roc <- roc(Predict_early_euth_df$Euth_Early ~ otu_euth_probs[ , 2])

#otu_euth_model <- rf_early_aucrf$RFopt
#rf_early_aucrf$Kopt
#rf_early_aucrf$Xopt
#rf_early_aucrf$RFopt$confusion
#OptimalSet(rf_early_aucrf)
#plot(otu_euth_model_cv)
#plot(otu_euth_model, which="ranking") 
#plot(otu_euth_model, which="psel") 

aucrf_data <- Predict_early_euth_df[,c('Euth_Early',rf_early_aucrf$Xopt)]

#### 10-fold Cross validated - 10 repetitions
start <- proc.time()[3]
iters <- 100
cv10f_aucs <- c()
cv10f_all_resp <- c()
cv10f_all_pred <- c()
for(j in 1:iters){
  sampling <- sample(1:nrow(aucrf_data),nrow(aucrf_data),replace=F)
  cv10f_probs <- rep(NA,nrow(aucrf_data))
  for(i in seq(1,nrow(aucrf_data),5)){
    train <- aucrf_data[sampling[-(i:(i+4))],]
    test <- aucrf_data[sampling[i:(i+4)],]
    temp_model <- AUCRF(Euth_Early~., data=train, pdel=0.99, ntree=500)
    cv10f_probs[sampling[i:(i+4)]] <- predict(temp_model$RFopt, test, type='prob')[,2]
  }
  cv10f_roc <- roc(aucrf_data$Euth_Early~cv10f_probs)
  cv10f_all_pred <- c(cv10f_all_pred, cv10f_probs)
  cv10f_all_resp <- c(cv10f_all_resp, aucrf_data$Euth_Early)
  cv10f_aucs[j] <- cv10f_roc$auc
}
cv10f_roc <- roc(cv10f_all_resp~cv10f_all_pred)
end <- proc.time()[3]
time <- end-start

#### leave-one-out
LOO_probs <- NULL
LOO_probs <- sapply(1:nrow(aucrf_data), function(i){
 train <- aucrf_data[-i,]
  test <- aucrf_data[i,]
  temp_model <- AUCRF(Euth_Early~., data=train, pdel=0.99, ntree=500)
  LOO_probs[i] <- predict(temp_model$RFopt, test, type='prob')[,2]
})
LOO_roc <- roc(aucrf_data$Euth_Early~LOO_probs)

#### plot rocs
par(mar=c(4,4,1,1))
plot(c(1,0),c(0,1), type='l', lty=3, xlim=c(1.01,0), ylim=c(-0.01,1.01), xaxs='i', yaxs='i', ylab='', xlab='')
plot(otu_euth_roc, col='black', lwd=2, add=T, lty=1)
plot(cv10f_roc, col='gray', lwd=2, add=T, lty=1)
plot(LOO_roc, col='blue', lwd=2, add=T, lty=2)
mtext(side=2, text="Sensitivity", line=2.5)
mtext(side=1, text="Specificity", line=2.5)
legend('bottomright', legend=c(sprintf('Out-Of-Bag (AUC: %.3g)',otu_euth_roc$auc),
                               sprintf('Leave-1-out (AUC: %.3g)',LOO_roc$auc),
                               sprintf('10-fold CV (AUC: %.3g)',cv10f_roc$auc),
                               sprintf('OOB vs Leave-1-out: p=%.2g', roc.test(otu_euth_roc,LOO_roc)$p.value),
                               sprintf('OOB vs 10-fold CV: p=%.2g', roc.test(otu_euth_roc,cv10f_roc)$p.value)
),lty=c(1,2,1,0,0), lwd=2, col=c('black','blue','gray'), bty='n')
```


```{r fig.width=10, fig.height=5}
layout(matrix(c(1,3,2,2), nrow=2))


#AUCRF curve
par(mar=c(5,5,1.5,1))
plot(rf_early_aucrf)
#mtext('A', at=-90, font=2, side=3)

#Importance Plot
euth_otus <- rf_early_aucrf$Xopt
euth_tax <- get_tax(1, euth_otus, tax_file)
euth_tax$tax_label <- paste(gsub('_unclassified', '', euth_tax$tax),
                                   ' (', gsub('tu0*', 'TU ', rownames(euth_tax)), 
                                   ')', sep = '')
dotchart(rev(rf_early_aucrf$ranking[euth_otus]), labels=rev(euth_tax[euth_otus, 'tax_label']), xlab='Mean Decrease Accuracy')
#mtext('B', at=-0.014, font=2, side=3)

#Abundance stripchart or most predictive otus
euth_otus <- rf_early_aucrf$Xopt
euth_otus <- rev(euth_otus[1:5])
early_abunds <- Predict_early_euth_df[Predict_early_euth_df$Euth_Early==0, euth_otus]/10000 + 1e-4
late_abunds <- Predict_early_euth_df[Predict_early_euth_df$Euth_Early==1, euth_otus]/10000 + 1e-4

par(mar=c(4, 9, 1, 1))
plot(1, type="n", ylim=c(0,length(euth_otus)*2), xlim=c(1e-4,1e-2), log="x", ylab="", xlab="Relative Abundance (%)", xaxt="n", yaxt="n")
index <- 1
for(i in euth_otus){
  stripchart(at=index-0.35, jitter(early_abunds[,i], amount=1e-5), pch=21, bg="royalblue1", method="jitter", jitter=0.2, add=T, cex=1, lwd=0.5)
  stripchart(at=index+0.35, jitter(late_abunds[,i], amount=1e-5), pch=21, bg="orange", method="jitter", jitter=0.2, add=T, cex=1, lwd=0.5)
  segments(mean(early_abunds[,i]),index-0.7,mean(early_abunds[,i]),index, lwd=3)
  segments(mean(late_abunds[,i]),index+0.7,mean(late_abunds[,i]),index, lwd=3)
  index <- index + 2
}
axis(2, at=seq(1,index-2,2), labels=euth_tax[euth_otus, 'tax_label'], las=1, line=-0.5, tick=F, cex.axis=0.8)
axis(1, at=c(1e-4, 1e-3, 1e-2), label=c("0", "0.1", "1"))
legend('topright', legend=c("Persistant", "Susceptible"), pch=c(21, 21), pt.bg=c("orange","royalblue1"), cex=0.7)
#mtext('C', at=1e-7, font=2, side=3)
dev.off()

```