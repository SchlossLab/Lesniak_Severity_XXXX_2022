---
title: "CdGF_aucrf"
author: "Nicholas Lesniak"
date: "September 15, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r}
pack_used <- c('randomForest','ggplot2', 'pROC', 'knitr','dplyr','AUCRF', 'tidyr', 'caret')
for (dep in pack_used){
  if (dep %in% installed.packages()[,"Package"] == FALSE){
    install.packages(as.character(dep), repos = 'http://cran.us.r-project.org', 
                     quiet=TRUE);
  }
  library(dep, verbose=FALSE, character.only=TRUE)
}
```

## Can Day 0 Community members predict C. difficile CFU?
```{r setup data, fig.height= 10, fig.width=10}

meta_file   <- '~/Documents/Github/Schubert_humanCdGF_XXXX_2016/data/process/human_CdGF_metadata.txt'
shared_file <- '~/Documents/Github/Schubert_humanCdGF_XXXX_2016/data/process/human_CdGF.an.unique_list.0.03.subsample.shared'
tax_file <- '~/Documents/Github/Schubert_humanCdGF_XXXX_2016/data/process/gf_new.an.taxonomy'
tax_function <- '~/Documents/Github/Schubert_humanCdGF_XXXX_2016/code/tax_level.R'

# read in files
meta_file   <- read.table(meta_file, sep = '\t', header = T, row.names = 'sample_id')
shared_file <- read.table(shared_file, sep = '\t', header = T, row.names = 'sample_id')
tax_file <- read.table(tax_file, sep = '\t', header = T, row.names = 'OTU')
source(tax_function)

seed <- 1
n_trees <- 2001
iters <- 100
otu_presence_cutoff <- 0.1
cor_cutoff <- 0.75


# select only mice with 431 cdiff
meta_file <- meta_file[meta_file$cdiff_strain == '431', ]

# remove cage NP1 (no confirmed infection)
meta_file <- meta_file[!meta_file$cage_id == 'NP1', ]

# subset shared
#Create df with relative abundances
stool_shared <- shared_file[rownames(meta_file[meta_file$day %in% 0, ]), ]
# use %in% instead of == in order to ignore NA
# rename day 0 community rows by mouse id - since meta rows have day in row names, use mouse id for both
rownames(stool_shared) <- meta_file$mouse_id[rownames(meta_file) %in% 
                                               rownames(stool_shared) ]
rel_abund_stool <- 100 * stool_shared / unique(apply(stool_shared, 1, sum))
#Create vector of OTUs with median abundances >1%
otu_presence <- ifelse(stool_shared > 0, T, F) 
OTUs_present <- colnames(stool_shared[ , apply(otu_presence, 2, sum) > round(otu_presence_cutoff*nrow(stool_shared))])
#df of OTUs with present in >10%
rel_abund_stool <- rel_abund_stool[ ,OTUs_present]

# remove correlative otus
rel_abund_cor <- cor(rel_abund_stool, method = 'spearman')
cor_otus <- findCorrelation(rel_abund_cor, cutoff = cor_cutoff)
rel_abund_stool <- select(rel_abund_stool, -cor_otus)
```

### Can we predict moribundity with the community structure at Day 0?

```{r roc, fig.width=8, fig.height=8, results= 'hide'}
#create dataframe for RF-classification
meta_file$Euth_Early <- factor(ifelse(meta_file[ , 'Early_Euth'] == FALSE, 0, 1)) 

Predict_df <- merge(meta_file[meta_file$day %in% 0, 
                              c('human_source', 'mouse_id', 'cage_id', 'Euth_Early')],
                    rel_abund_stool, by.x = 'mouse_id', by.y = 'row.names')

# remove cage/inocula OTUs from prediction dataframes
Predict_early_euth_df <- select(Predict_df, -cage_id, -mouse_id, -human_source)

# create RF model
set.seed(seed)
rf_early_aucrf <- AUCRF(Euth_Early ~ ., data = Predict_early_euth_df,
                              ntree = n_trees, pdel = 0.05, ranking = 'MDA')

otu_euth_probs <- predict(rf_early_aucrf$RFopt, type = 'prob')
otu_euth_roc <- roc(Predict_early_euth_df$Euth_Early ~ otu_euth_probs[ , 2])
euth_otu_feat <- rf_early_aucrf$Xopt

aucrf_data <- Predict_early_euth_df[,c('Euth_Early',euth_otu_feat)]

#### leave-one-out
LOO_probs <- NULL
LOO_probs <- sapply(1:nrow(aucrf_data), function(i){
 train <- aucrf_data[-i,]
  test <- aucrf_data[i,]
  set.seed(seed)
  temp_model <- AUCRF(Euth_Early~., data=train, pdel=0.99, ntree=500)
  LOO_probs[i] <- predict(temp_model$RFopt, test, type='prob')[,2]
})
LOO_roc <- roc(aucrf_data$Euth_Early~LOO_probs)

#### 10-fold Cross validated - 10 repetitions
cv10f_aucs <- c()
cv10f_all_resp <- c()
cv10f_all_pred <- c()
for(j in 1:iters){
  set.seed(j)
  sampling <- sample(1:nrow(aucrf_data),nrow(aucrf_data),replace=F)
  cv10f_probs <- rep(NA,52)
  for(i in seq(1,50,5)){
    train <- aucrf_data[sampling[-(i:(i+4))],]
    test <- aucrf_data[sampling[i:(i+4)],]
    set.seed(seed)
    temp_model <- AUCRF(Euth_Early~., data=train, pdel=0.99, ntree=500)
    cv10f_probs[sampling[i:(i+4)]] <- predict(temp_model$RFopt, test, type='prob')[,2]
  }
  cv10f_roc <- roc(aucrf_data$Euth_Early~cv10f_probs)
  cv10f_all_pred <- c(cv10f_all_pred, cv10f_probs)
  cv10f_all_resp <- c(cv10f_all_resp, aucrf_data$Euth_Early)
  cv10f_aucs[j] <- cv10f_roc$auc
}
cv10f_roc <- roc(cv10f_all_resp~cv10f_all_pred)

#### One_mouse trainset
Predict_om_df <- select(Predict_df, 
                        Euth_Early, human_source, mouse_id, contains('Otu'))
om_import_otus <- data.frame(otu = colnames(select(Predict_om_df, contains("Otu"))))
om_aucs <- c()
om_all <- c()
om_probs <- c()
for(j in 1:iters){
  set.seed(j)
  train <- Predict_om_df %>% 
    group_by(human_source) %>% 
    sample_n(1) %>% ungroup() 
  test <- filter(Predict_om_df, !mouse_id %in% train$mouse_id)
  set.seed(seed)
  temp_model <- AUCRF(Euth_Early~., data=select(train, -mouse_id, -human_source), 
                      pdel=0.1, ntree=1000, ranking = 'MDA')
  om_probs <- rbind(om_probs,
                    data.frame(obs = test$Euth_Early,
                               pred = predict(temp_model$RFopt, test, type='prob')[,2]))
  om_roc <- roc(om_probs$obs~om_probs$pred)
  selected_var <- temp_model$ranking[temp_model$Xopt]
  om_import_otus <- merge(om_import_otus,
                          data.frame(otu = names(selected_var), 
                                     rank = rank(selected_var)/max(rank(selected_var))),
                          by = 'otu', all.x = T, 
                          suffixes = c('',paste0('_auc_', round(om_roc$auc, 3))))
  om_all <- rbind(om_all, om_probs)
  om_aucs[j] <- om_roc$auc
}
om_roc <- roc(om_all$obs~om_all$pred)

raw_importance <- data.frame(om_import_otus[ , -c(1)], row.names = om_import_otus$otu)
importance_otus <-   apply(raw_importance, 1, sum, na.rm = T)
importance_otus <- importance_otus[importance_otus>0]
importance_otus <- importance_otus[importance_otus > mean(importance_otus)]
om_import_otus <- names(sort(importance_otus, decreasing = T))

#### leave-one-source-out
LOcO_df <- Predict_df %>% 
                select(Euth_Early, human_source, one_of(om_import_otus))
source_list <- as.character(unique(LOcO_df$human_source))

LOcO_probs <- c()
LOcO_rf <- c()
for(i in 1:length(source_list)){
  source <- LOcO_df$human_source == source_list[i]
  LOcO_predict <- select(LOcO_df, -human_source)
  train <- LOcO_predict[!source,]
  test <- LOcO_predict[source,]
  set.seed(seed)
  temp_model <- AUCRF(Euth_Early~., data=train, pdel=0.99, ntree=500)
  LOcO_rf[[i]] <- temp_model$RFopt
  LOcO_probs[LOcO_df$human_source == source_list[i]] <- predict(temp_model$RFopt, test, type='prob')[,2]
}
LOcO_roc <- roc(LOcO_df$Euth_Early~LOcO_probs)

#### leave-2-out
LOdO_df <- Predict_df %>% 
                select(Euth_Early, human_source, one_of(om_import_otus))
donor_list <- as.character(unique(LOdO_df$human_source))

LOdO_probs <- c()
LOdO_rf <- c()
for(i in seq(1,length(donor_list),2)){
  set.seed(seed)
  donors <- sample(donor_list)
  by_donor <- LOdO_df$human_source %in% donors[i:(i+1)]
  LOdO_predict <- select(LOdO_df, -human_source)
  train <- LOdO_predict[!by_donor,]
  test <- LOdO_predict[by_donor,]
  set.seed(seed)
  temp_model <- AUCRF(Euth_Early~., data=train, pdel=0.99, ntree=500)
  LOdO_rf[[i]] <- temp_model$RFopt
  LOdO_probs[LOdO_df$human_source %in% donors[i:(i+1)]] <- predict(temp_model$RFopt, test, type='prob')[,2]
}
LOdO_roc <- roc(LOdO_df$Euth_Early~LOdO_probs)

#### One_mouse-Leave one out model 
om_loo_df <- select(Predict_df,  
                    Euth_Early, human_source, mouse_id, one_of(om_import_otus)) 
om_loo_otus <- data.frame(otu = om_import_otus)

om_loo_aucs <- c() 
om_loo_all <- c() 
for(j in 1:iters){ 
  set.seed(j) 
  mouse_set <- om_loo_df %>%  
    group_by(human_source) %>%  
    sample_n(1) %>% ungroup()  
  om_loo_probs <- c() 
  om_source_import <- data.frame(otu = om_import_otus) 
  for(n in unique(as.character(mouse_set$human_source))){ 
    train <- mouse_set[mouse_set$human_source != n, ] 
    test <- om_loo_df %>%  
      filter(human_source %in% n) 
    set.seed(seed) 
    temp_model <- AUCRF(Euth_Early~., data=select(train, -mouse_id, -human_source), 
                        pdel=0.99, ntree=500, ranking = 'MDA') 
    om_loo_probs <- rbind(om_loo_probs, 
                          data.frame(obs = test$Euth_Early, 
                                     pred = predict(temp_model$RFopt, 
                                                    test, type='prob')[,2])) 
    om_source_import <- merge(om_source_import,
                            data.frame(otu = names(temp_model$ranking), 
                                       rank = rank(temp_model$ranking)/
                                              max(rank(temp_model$ranking))),
                            by = 'otu', all.x = T, 
                            suffixes = c('',paste0('_', n)))
  } 
  om_loo_roc <- roc(om_loo_probs$obs~om_loo_probs$pred) 
  om_loo_otus <- merge(om_loo_otus, om_source_import,
                       by = 'otu', all.x = T, suffixes = c('',paste0('_',j)))
  om_loo_all <- rbind(om_loo_all, om_loo_probs) 
  om_loo_aucs[j] <- om_loo_roc$auc 
} 
om_loo_roc <- roc(om_loo_all$obs~om_loo_all$pred) 
 
raw_importance <- data.frame(om_source_import[ , -c(1,2)], row.names = om_source_import$otu) 
 
om_loo_import_otus <- apply(raw_importance, 1, sum, na.rm = T)
om_loo_import_otus <- om_loo_import_otus[om_loo_import_otus > mean(om_loo_import_otus)]
important_otus_om_loo <- names(sort(om_loo_import_otus, decreasing = T))
```

#### RF with all mice input  

```{r All data plt, fig.width=8, fig.height=8, results= 'hide'}
#### plot rocs
# all mice
par(mar=c(4,4,1,1))
plot(c(1,0),c(0,1), type='l', lty=3, xlim=c(1.01,0), ylim=c(-0.01,1.01), xaxs='i', yaxs='i', ylab='', xlab='')
plot(otu_euth_roc, col='gray', lwd=2, add=T, lty=2)
plot(cv10f_roc, col='black', lwd=2, add=T, lty=1)
plot(LOO_roc, col='blue', lwd=2, add=T, lty=3)
mtext(side=2, text="Sensitivity", line=2.5)
mtext(side=1, text="Specificity", line=2.5)
legend('bottomright', legend=c(sprintf('Out-Of-Bag (AUC: %.3g)',otu_euth_roc$auc),
                               sprintf('Leave-1 mouse-out (AUC: %.3g)',LOO_roc$auc),
                               sprintf('10-fold CV (AUC: %.3g)',cv10f_roc$auc) #,
#                               sprintf('OOB vs Leave-1-out: p=%.2g', roc.test(otu_euth_roc,LOO_roc)$p.value),
#                               sprintf('OOB vs 10-fold CV: p=%.2g', roc.test(otu_euth_roc,cv10f_roc)$p.value)
),lty=c(2,1,3), lwd=2, col=c('gray','black','blue'), bty='n')
```

#### RF with features from One_mouse_per_source  

```{r one_mouse plots, fig.width=8, fig.height=8, results= 'hide'}
#remove cage bias plots
par(mar=c(4,4,1,1))
plot(c(1,0),c(0,1), type='l', lty=3, xlim=c(1.01,0), ylim=c(-0.01,1.01), xaxs='i', yaxs='i', ylab='', xlab='')
plot(om_roc, col='black', lwd=2, add=T, lty=1)
plot(LOcO_roc, col='purple', lwd=2, add=T, lty=3)
plot(LOdO_roc, col='red', lwd=2, add=T, lty=3)
plot(om_loo_roc, col='blue', lwd=2, add=T, lty=2)
mtext(side=2, text="Sensitivity", line=2.5)
mtext(side=1, text="Specificity", line=2.5)
legend('bottomright', legend=c(sprintf('One-mouse (AUC: %.3g)',om_roc$auc),
                           sprintf('Leave-1 source-out (AUC: %.3g)',LOcO_roc$auc),
                           sprintf('Leave-2 sources-out (AUC: %.3g)',LOdO_roc$auc),
                           sprintf('One-mouse-Leave-1 source-out (AUC: %.3g)',om_loo_roc$auc)),
       lty=c(1,3,3,2), lwd=2, col=c('black','purple','red','blue'), bty='n')
```

### Partial Dependency with Relative Abundance Overlayed Plots
###### Using features selected by one-mouse-per-source model


```{r rel abund partial depend, fig.width=10, fig.height=10}

partialplot_df <- Predict_early_euth_df[,c('Euth_Early',important_otus_om_loo)]
pp_aucrf <- AUCRF(Euth_Early ~ ., data = partialplot_df,
                  ntree = 500, pdel = 0.99)

cor_features <- sapply(as.character(important_otus_om_loo), 
                       function(i)rownames(rel_abund_cor)[rel_abund_cor[,i] > cor_cutoff])


layout(matrix(c(1:12), ncol=3, byrow=TRUE))
par(mar = c(6,4,4,2)+0.1)
for (i in seq_along(important_otus_om_loo)) {
  partial_otu <- partialPlot(pp_aucrf$RFopt, partialplot_df, important_otus_om_loo[i], xlab='',
                main=NULL)
  if(length(cor_features[[i]]) > 1){
      title(main = paste0('Unidentifiable Feature (', 
                          get_tax(row_list = important_otus_om_loo[i])$tax_label,
                          ' Shown)'))
      mtext(side = 1, line = 6, cex = 0.6,
        paste('Correlated features: \n', 
              paste(paste0(get_tax(row_list = cor_features[[i]])$tax_label, c(', ', ',\n ')), 
                    collapse = '')))
  } else {
      title(paste(get_tax(row_list = important_otus_om_loo[i])$tax_label))
  }
points(partialplot_df[partialplot_df$Euth_Early == 1 ,important_otus_om_loo[i]], 
       jitter(rep(0.25*(diff(range(partial_otu$y))) + min(partial_otu$y), 
                  sum(partialplot_df$Euth_Early == 1)), 
              amount = (0.1*(diff(range(partial_otu$y))))), 
              pch = 21, bg = 'red')
points(partialplot_df[partialplot_df$Euth_Early == 0 ,important_otus_om_loo[i]], 
       jitter(rep(0.75*(diff(range(partial_otu$y))) + min(partial_otu$y), 
                  sum(partialplot_df$Euth_Early == 0)), 
              amount = (0.1*(diff(range(partial_otu$y))))), 
              pch = 21, bg = 'gray')
  axis(side = 4, labels = c('Severe', 'Mild'),
       at = c(0.25*(diff(range(partial_otu$y))) + min(partial_otu$y),
              0.75*(diff(range(partial_otu$y))) + min(partial_otu$y)))
}
plot(NULL, xlim = c(0,1), ylim = c(0,1), xlab = '', ylab = '', axes = F)
legend('topleft', c('Mild', 'Severe'), pch = 21, pt.bg = c('gray','red'), cex = 2)
```

#### Notes
* CFU data doesnt help model, likely due to samples lost due to lack of cfu data which are biased towards the severe samples  
    - Day 1 CFU loses 2 samples  [AUCRF model with Day 1 CFU](~/Documents/Github/Schubert_humanCdGF_XXXX_2016/code/CdGF_AUCRF_withCFU_day1.html)  
    - Day 2 cfu loses 14 samples, 10 are severe  [AUCRF model with Day 2   CFU](~/Documents/Github/Schubert_humanCdGF_XXXX_2016/code/CdGF_AUCRF_withCFU_day2.html)  
* Diversity/Enterotype don't help model - When adding enterotype, diversity, and CFU, invsimpson and cfu appear as features, but when cfu is removed, invsimpson is no longer a predictor  
* Model run with both relative and absolute abundances and no significant difference in their output

***  
***  
